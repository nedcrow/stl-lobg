0923
Title Framework 만듬
Lobby로가는 서버 시스템 생성

0924
Title에서 UserID를 입력해서 서버에 들어가면 GameInstance에 아이디를 저장하는 기능추가 SaveUserID()
BattlePlayer의 crosshair HUD띄우기

컨트롤러에서 키입력을 받아 BattleCharacter에서 라인트레이스
총알이 조준한 방향으로 날아가는 기능 작성중

BulletBase라는 클래스와 블프로 Weapon폴더에 다시 만듬

0925
총알이 목표한 지점에 도달하도록 수정
하늘을 향해 발사해도 총알이 스폰되도록 수정
연사가 가능하도록 수정
총알이 플레이어나 다른 액터에 맞으면 없어지도록 수정
TakeDamage해서 죽는 애니메이션이 나오도록 연결
CurrentHP가 0이 되서 죽으면 리스폰되는 기능 추가
리스폰 기능을 게임모드로 옮기는 작업중

0926
리스폰 기능을 게임모드에서 호출하는 걸로 수정

0927
리스폰을 플레이어의 위치를 옮기는게 아닌 기존의 플레이어는 파괴하고 새 플레이어를 스폰시키는 방식으로 변경
게임모드에서 리스폰 위치를 가져오고 플레이어를 스폰 시킨 후 컨트롤러를 가져와 플레이어로 할당

해봐야 할 거 작성 : 몬스터가 죽었을 경우 경험지나 코인을 플레이어에게 전해줄 시스템 구성
임시로 박스 액터 놓고 작업할 것
리스폰 시 새로 스폰된 플레이어와 PlayerState의 동기화 작업 그전에 PlayerState에 넣을 항목 구성

임시로 미니언 액터를 만들어 미니언이 체력이 0이하가 되면 막타를 친 캐릭터가 돈과 경험치를 가져가도록 기능 추가
미니언이 준 돈과 경험치는 PlayerPS에 업데이트 되도록 BattleCharacter에 함수 추가
Bullet클래스에서 충돌한 액터가 미니언인지 플레이어 인지 검사해서 다른 데미지를 전달하도록 추가

0928
PlayerState와 UI의 동기화
리스폰 시 UI 초기화 : 체력은 꽉 차고 돈과 경험치는 그대로
경험치의 백분율 작업중

0930
데미지 테이블데이터 만들어 볼려고 했는데 잘 모르겠다.. 나중으로 미룸

1001
임시 타워를 만들고 타워가 전부 파괴되면 lobby로 넘어가는 순환 추가
타워는 게임모드에서 클래스를 받고 있어서 나중에 진짜 타워가 완성되면 게임모드의 타워 클래스로 넣어주면 된다.
경험치 UI가 경험치 수치에 맞게 게이지가 차도록 수정 이상하게 올라가던걸 수정했다.
타이틀과 로비 PC의 BeginPlay에 IsLocallyPlayerController()를 if문에 추가 에러나는 걸 방지

빨강팀 파란팀을 나누는 과정에서 GetPlayerControllerIterator()가 여러번 실행되는 문제점 발생,
원하는 결과가 나오지 않음

1002
팀나누는 과정을 로비에서 하기로 변경하고 작성했으나 아직 원하는 결과가 나오지 않는다.

1003
로비에서 접속한 플레이어를 빨강, 파랑 팀으로 나누고 UI로 표시하고 네트워크 동기화까지 함
문제는 UI네트워크 동기화 중에 다른 플레이어의 TeamColor를 바꿔버리는 문제 발생
내일 해결할 예정

1004
타이틀에서 로비로 접속하면 빨강, 파랑 팀으로 나누어지고 다른 클라이언트들도 UI 동기화된다.
게임인스턴스의 TeamColor라는 변수에 색을 넣어놔서 Battle 레벨로 넘어가도 팀이 유지된다.

1005
로비에서 정한 팀을 플레이어스테이트에 저장하고 각 플레이어에도 태그를 설정했다.
총알이 태그를 검사하고 같은 팀이라면 return해서 대미지를 가하지 않는다.
Reload애니메이션 동기화되지 않던 문제 수정
캐릭터에 총 매시를 달고 총 muzzle에서 총알이 스폰되도록 수정

1006
현재 진행된 사항
1. 타이틀에서 로그인하면 로비로 이동
2. 로비에서 팀이 나뉘지고 게임 인스턴스에 저장
3. 배틀필드로 넘어가면서 게임인스턴스에 저장된 팀에 따라 태그를 부여
4. 팀전을 펼쳐서 상대 타워, 보스를 먼저 쓰러트리면 승리
5. 타워가 전부 부숴지면 로비로 다시 이동
6. 반복

할 것
1. 상대방, 미니언, 타워, 보스의 체력이 보이게 한다
2. 에임 오프셋
3. 아이템

하던거 정리하는 시간
HPBar를 만든다.
UWidgetComponent를 받는다. HPBar로 설정한다.

체력이 변하면 HPBar를 업데이트 하도록 작성한다.
어디서? 캐릭터에서? 자신이 로컬이 아닐때만?

자기자신은 보이지 않고 상대방은 보이게 설정
어디서? 로컬컨트롤러라면 보이지 않고 아니라면 보이게 설정
게임모드에서 컨트롤러 돌면서 설정? 컨트롤러 돌면서 각자 가지고 있는 폰한테
NetMulticast로 설정?
모든 HPBar는 로컬 플레이어를 향하도록 설정
어떻게? 자신이 로컬 플레이어인지 확인 ? 잘모르겠다

1006 한것
상대 체력이 보여야하기에 HUDHPBar를 만들어서 띄우고 카메라의 회전에 맞춰서 허드도 회전하도록 했다.
IsLocallyControlled()로 로컬에서 제어한다면 HUD를 안보이게 했다.
팀에 따라 HUD의 색깔을 다르게 하고 싶었지만 아직 완성하지 못함

%%%%%%% HUD띄우는 법 %%%%%%%%%
1. 헤더에 컴포넌트로 HUDBarSceneComponent와 UWidgetComponent를 설정한다.
밑에랑 같이 쓰면 됨

UPROPERTY(BlueprintReadWrite, EditAnywhere)
class UHUDBarSceneComponent* HPBarHUD;

UPROPERTY(BlueprintReadWrite, EditAnywhere)
class UWidgetComponent* Widget;

2. cpp에 인클루드 한다
UI폴더(블루프린트 폴더 아님)의 HUDBarSceneComponent와 UHPBarWidgetBase
그리고 Components/UWidgetComponent 를 include 하고

#include "../UI/HPBarWidgetBase.h"
#include "../UI/HUDBarSceneComponent.h"
#include "Components/WidgetComponent.h"
UI폴더는 알아서 잘 찾아가야한다.

컴포넌트인 HPBarHUD와 Widget을 CreateDefaultSubobject한다.
HPBarHUD는 RootCompoennt의 자식으로, Widget은 HPBarHUD의 자식으로 설정한다.
HPBarHUD의 위치를 적절히 설정하고 Widget은 SetRelativeRotation()으로 회전값을 Yaw방향으로 180을 설정한다(중요)

ex)
HPBarHUD = CreateDefaultSubobject<UHUDBarSceneComponent>(TEXT("HPBarHUD"));
HPBarHUD->SetupAttachment(RootComponent);
HPBarHUD->SetRelativeLocation(FVector(0, 0, 110));

Widget = CreateDefaultSubobject<UWidgetComponent>(TEXT("Widget"));
Widget->SetupAttachment(HPBarHUD);
Widget->SetRelativeRotation(FRotator(0, 180.f, 0));

3. UpdateHPBar라는 함수를 만든다.
UHPBarWidgetBase* HPWidget = Cast<UHPBarWidgetBase>(Widget->GetUserWidgetObject());
	if (HPWidget)
	{
		HPWidget->SetHPBar(CurrentHP / MaxHP);
	}
를 복사 붙여넣기하고 BeginPlay()와 CurrentHP가 변할 때 호출해준다.

4. 블루프린트에디터에서 Widget 컴포넌트를 클릭하고 디테일에 UserInterface에 Widget Class를 
원하는 위젯블루프린트로 설정한다. 이미 HPBarUI라는 위젯 블루프린트가 있으니 그거로 설정해도 된다.
사이즈를 200, 30정도로 설정하면 된다.

5. 원하는 결과가 나오지 않을 때는 CurrentHP와 MaxHP가 있는지 확인해보고 CurrentHP가 MaxHP로 초기화되어있는지,
BeginPlay에서 UpdateHPBar()를 호출하고 있는지 확인한다.

1007
팀에 따라서 HPHUD의 색이 변하는 네트워크 동기화 동작
팀에 따라 스폰진영 설정 작업중

플레이어컨트롤러의 Possess는 서버에서만 사용해야 한다. 클라이언트에서 사용하면 제대로 동작하지 않는다.
위젯을 클라이언트 함수로 생성하고 서버에서 스폰위치가 겹치지 않게 플레이어를 생성한 후 플레이어컨트롤러에
Possess한다

월드세팅에서 DefaultPlayer를 None으로 설정해서 사용하고 있으므로 주의

1008
오늘 할 것 : 팀을 구별해서 서로 다른장소에 스폰하기

모든 액터에 다 할 순 없어서 overlap OnHit

허드의 SetVisibility()를 플레이어의 BeginPlay에서 실행하면 생성자에서 허드를 만드는 과정인 CreateWidget이
WidgetComponent의 BeginPlay에서 실행되므로 플레이어와 위젯간의 BeginPlay의 실행 순서의 애매함이 있다.
그래서 위젯 클래스 안에서 NativeConstruct에서 SetVisibility를 하면 생성 후에 실행하므로 순서를 지키게 된다.

HUD의 색 변경을 플레이어 자체적으로 설정
왜? 
플레이어를 생성하고 Possess하는 과정이 서버와 클라이언트들의 순서대로 진행되기 때문에
가장 마지막 클라이언트에서는 폰을 생성하기 전에 서버에서 PS의 TeamColor를 설정하는 코드가 진행돼서
PS의 OnRep_TeamColor가 폰을 가져오는 구간에서 디폴트 폰을 가져와 버린다.
플레이어 자체적으로 혹은 허드 자체적으로 색을 변경하도록 수정하면 플레이어가 생성된 후에 바뀌므로 그럴일이 없다.

플레이어에서 바꾸냐 허드 자체적으로 바꾸냐의 문제는 플레이어로 결정
왜? TeamColor를 PS의 TeamColor에 설정해야 하는데 허드에서 하면 GetOwner()같은 걸로 접근하고
폰과 PC를 캐스팅해 가져오고 거기서 PS에 접근해서 입력해야한다. 여러번의 캐스팅과 접근이 있으므로
플레이어에서 하면 PS에 바로 접근해서 설정할 수 있다. 그리고 이미 컨트롤러에 GI의 Teamcolor가 저장되어있다.
문제가 있을까?

주말에 할 것
Battle의 TeamColor를 넣어줄것
서버에서 가지고 있을 것
PlayerState에서 가지고 있을 것
캐릭터 생성 후 PS에서 가져와서 태그, 허드, TeamName 설정

1010
1. 로비에서 서버의 GI에 저장한 유저아이디 배열을 배틀레벨의 게임모드에서 가져오고
2. 컨트롤러를 순회하면서 배열을 검사해 Red배열에서 발견되면 PS에 Red팀이라고 저장, Blue도 동일작업 수행
3. 플레이어를 스폰하고 PS의 TeamColor에 따라 허드와 위젯의 HP색을 바꿔줌

2단계의 PS에 TeamColor를 설정할 때 Red, Blue배열을 돌면서 PC가 그 아이디를 가지고 있는지 검사해야하는데
서버의 PC는 자신의 아이디를 모르는 상태다
그래서 PC의 BeginPlay에서 자신의 아이디를 서버로 보내주고 서버의 PC가 아이디를 받으면 게임모드의
CheckAllControllerHasName()를 실행
전체 플레이어 수와 bool값의 TArray의 Num()이 같다면 모든 서버의 컨트롤러가 아이디를 알고 있다는 뜻이된다.
그때 PS의 TeamColor를 설정하는 함수를 실행하도록 했다.
PostLogin으로 실행하게 되면 서버의 PC는 자신의 아이디가 뭔지 모르는 상태여서 제대로 나오지 않는다.
아이디를 전부 보냈는지 확인 후에 실행해야한다.

실행 순서 : 게임모드 BeginPlay에서 GI의 배열 가져오기 -> 클라이언트 PC에서 서버 PC로 유저아이디 보내기->
서버PC가 게임모드의 CheckAllControllerHasName()실행 -> 서버의 모든 PC가 이름을 가지고 있다면 PS 설정 함수 실행
-> 서버에서 PC들과 팀 배열을 돌며 PS에 TeamColor 설정 -> 플레이어를 팀에 맞춰서 스폰하고 허드와 위젯색 변경

1011
로비에서 팀이 설정되고 팀을 변경하고 싶을 때 팀 위젯에 마우스 오른쪽 버튼을 눌러 팀을 변경하고자 하는 기능을
넣고싶었음
위젯을 만들고 마우스 오른쪽 클릭 시 Visible하는 작업을 함
구조를 고민

1012
구조를 잘 짜지 못해서 TeamSlot에 하나씩 다 추가하는 방식을 선택
일단 동작하는게 중요하니까 나중에 좋은 생각이 나면 수정하는 방향으로 잡음
마우스 오른쪽 버튼을 누르면 Visible하고 보이는 버튼을 누르면 게임모드에서 팀 배열을 수정하여 위젯 업데이트

플레이어가 죽고나서 리스폰 될때 각팀 진영에서 리스폰 되도록 변경
리스폰 액터에 태그를 설정하고 리스폰 할때 태그를 검사해서 해당하는 리스폰에 SpawnActor()

리스폰 지역의 콜리전 안에서 F키를 누르면 상점 UI가 뜨도록 기능 추가
상점 UI의 아이템을 클릭하면 돈이 차감되고 캐릭터의 능력이 강해지도록 설정할 예정

1014
상점의 슬롯의 이미지와 텍스트, 이름을 디자이너가 설정할 수 있도록 변경
버튼을 누르면 아이템의 이미지에 따라 다른 로그가 출력되게 설정
내일 캐릭터에 직접 적용할 예정

1015
플레이어의 돈이 아이템 가격보다 충분하지 않다면 비활성화 되고 구매할 수 없다
돈이 살 수 있는 만큼 있다면 활성화 되고 클릭하면 구매한다 UI와도 동기화 된다

내일 할 것 AttackPoint의 PS동기화

1016
상점에서 아이템 구매 시 PS에 저장
AI 구동법 배움
애셋 찾기

1017
캐릭터 애셋 추가, 캐릭터 변경
배틀맵으로 넘어오면서 캐릭터를 고르는 기능 추가
아직 고른 캐릭터로 변경되진 않음 -> 내일 할 예정
랜더 타깃이 택스처?를 많이 잡아 먹는 듯 다른 방법 구상해야 함

1018
배틀 맵에서 플레이어 캐릭터를 고르는 후
고른 캐릭터로 매시와 애니메이션 블루프린트가 바껴서 나온다
사망 후 리스폰도 매시가 그대로 이다
태스트 맵을 만들었다

1019
애셋 추가

1020
로비에서 팀이 나눠질 때 자기자신은 초록색으로 보이게 수정
상점에서 살 수 없는 아이템의 비활성화를 더 비활성화처럼 보이게 수정
-> Hovered했을 때 변화 없고, 알파값을 더 낮췄다
스피드 아이템 먹었을 때 스프린트 시, 리스폰 시 초기화되던 버그 수정
PS에서 저장하고 불러온다

1022
베틀맵에 들어와서 카운트 다운이 시작되고 끝나면 미니언이 생성되도록 기능 추가 네트워크 상으로 동기화 된다

1023
Tab키를 누르면 플레이어들의 상태가 나오게 기능 추가
네트워크 동기화 완료

1025
문제점 1
클라이언트 리스폰 시 이상한 곳에 떨어짐 (해결)

문제점 2
페어리 리로드가 연산량이 너무 많아서 다른 액터 연산에 버벅거림

문제점 3
타워의 네트워크 동기화가 안됨

문제점 4
미니언 생성 시 연산량 때문에 그 순간 플레이어 리스폰 시 혹은 다른 작업 페어리 리로드라던지
그런 부분에서 연산이 안됨 NetMulticast나 Replicated가 안됨

문제점 5
미니언이 상대 타워에 도착 시 타워를 때리는게 아니라 미니언을 때림
다른 루트의 미니언을 때려버림
더 가까운 타워를 때리거나 우선순위를 매기거나 미니언의 스폰위치를 다르게 하거나 사거리를 줄이거나 해야함

문제점 6
리스폰 구역에서는 총을 발사하거나 맞아도 변화가 없거나 때린쪽이 데미지를 입음

문제점 7
리스폰 되면서 Tag에 업데이트 해버림 한번 더 생김 (해결)

1026
오늘 할 것
총 부품 상점에서 팔기
상점의 항목들을 csv로 받아와 데이터 테이블을 만들어서 구성

1027
상점의 조준경을 구매하면 FOV가 변하도록 추가

1028
보스 타워가 파괴되면 게임이 끝나도록 기능 추가
B키를 누르면 리스폰 구역으로 이동하도록 기능 추가
플레이어의 레벨업에 필요한 경험치를 DataTable로 받아오도록 수정
패키징 후 다른 컴퓨터에서 실행해봄

1029
오늘 할일
허드바 확인 -> 이유는 알 수 없지만 미니언의 HUD바의 색을 바꿀 때 NetMulticast도 Replicated도 BeginPlay도
하나만 사용하면 완벽하게 되진 않은 이유와 같다고 보인다. BeginPlay에서도 실행해주고 NetMulticast도 실행해주면
제대로 작동한다.

리스폰으로 돌아가는거 애니메이션, 이펙트 추가해보기
리스폰에서 체력차는거 구현하기 -> 그냥 가득 차도록 구현
리스폰에서 총알 이상한거 확인 -> 콜리전 설정으로 해결
스폰할 때 파란팀의 스폰 방향이 이상한거 수정

오늘 한일
리스폰 시 허드바가 동작 안하는 버그 해결
리스폰 매시, 콜리전 변경
리스폰에서 총알 버그 해결
리스폰에서 체력이 차도록 변경
맵 수정
체력포션의 인벤토리화 기능 추가

1030
오늘 할것
상점 개편
총알 수정(사이즈, 사거리 =? 수명, 컬러, 메쉬, 속도?)
총 사운드

변동 가능한 것
속도
사거리 바뀔수도..

정해져 있는 것
팀 컬러?

총이 바뀌면 총알도 바뀐다?
1. 총알 강화(공격력, 속도)
강화하는데 필요한 돈 Up
총알 Max 제한

방어력 개념 제안

1031
상점의 구조 개편
소비와 총, 강화로 나누었다
아이템 데이터 테이블을 순회하며 항목의 타입을 검사해 맞는 슬롯에 넣는다
총을 선택하면 플레이어의 총 매시가 바뀌도록 기능 추가

1101
상점에 플레이어 속도, 총알 속도 올리는 아이템으로 구분
플레이어 체력 올리는 아이템 구비
총의 강화에 따라 1성 2성 3성의 공격력을 표기
아이템 이미지 위에 마우스를 올리면 상세창이 보이도록 설정
체력을 PS에 설정해서 최대체력을 PS에서 가져오도록 설정
버그 : 리스폰될때 PS에서 MaxHP를 가져오는데 리스폰 되는 순간 리스폰의 콜리전과 겹쳐서
HP를 풀로 체우는 기능이 실행이 되는데 그 순간의 PS가 없고 MaxHP의 업데이트도 하지 않아서
초기값을 넣어버린다 그 후에 BeginPlay에서 MaxHP를 설정해도 변하지 않은 모습을 보인다
원인은 잘 모르겠다.
리스폰 위치를 높게 잡아서 생성 후에 떨어지면서 리스폰 콜리전과 BeginOverlap되게 하면 정상적으로 동작한다
시간이 없으므로 임시방편으로 리스폰 지역을 높게 잡아야할 듯
아니면 리스폰 지역을 콜리전과 안겹치는 곳으로 해야 한다

허드와 UI의 색을 변경하는것처럼 BeginPlay와 NetMulticast동시에 해주니 위의 문제는 해결이 됐는데
가끔 상점이 안열리던 문제가 다시 발생했다
자세히 보니 서버만 리스폰 되면서 콜리전이 겹치게 되면 bStoreOpen을 true로 바꾸어줘야하는데 안바꿔주는 듯하다
서버만 그런다 이걸 진짜 안바꿔주는지 아니면 상점을 열라고 하는 함수에서 뭔가 문제가 있는지 봐야한다
일단 위로 멀리 스폰하면 임시로 해결될거 같으니 제쳐두고 다른 기능 먼저 구현하겠다

총알의 속도 아이템을 구매하면 속도가 올라가도록 설정했다.
오래걸렸다....
하림님과 어느정도로 맞출지 정하도록 하자

총을 사면 공격력이 오르고 강화에 따라 현재 장착하고 있는 총이 강화된다. 공격력이 오른다
새로운 총을 사면 초기상태로 돌아간다

버그 : 클라에서는 다 강화해도 다시 슬롯이 보여버림

1102
버그해결, 위젯에 무기이름, 강화내역 띄움